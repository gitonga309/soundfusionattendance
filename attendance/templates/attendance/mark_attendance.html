<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Attendance | Sound Fusion</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: #333;
      padding: 20px;
    }
    .attendance-container {
      background: #fff;
      border-top: 4px solid #2ecc71;
      padding: 30px 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: #0d2818;
    }
    .date-info {
      background: rgba(46, 204, 113, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #0d2818;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .form-group {
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #0d2818;
    }
    input, select {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #2ecc71;
      outline: none;
      font-size: 14px;
      background: #f8f9fa;
      color: #333;
      transition: 0.3s;
      width: 100%;
    }
    input:focus, select:focus {
      border-color: #0d2818;
      background: #fff;
      box-shadow: 0 0 5px rgba(46, 204, 113, 0.3);
    }
    select {
      cursor: pointer;
    }
    button {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background-color: #2ecc71;
      color: #0d2818;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 5px;
    }
    button:hover {
      background-color: #27ae60;
    }
    .back-link {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }
    .back-link a {
      color: #2ecc71;
      text-decoration: none;
      font-weight: bold;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
    .edit-notice {
      background: rgba(46, 204, 113, 0.15);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #0d2818;
    }
    @media (max-width: 420px) {
      .attendance-container {
        padding: 20px 15px;
      }
      h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="attendance-container">
    <h2>
      {% if created %}
        Mark Today's Attendance
      {% else %}
        Update Today's Attendance
      {% endif %}
    </h2>
    
    <div class="date-info">
      üìÖ Date: {{ today|date:"F j, Y" }}<br>
      <span id="current-time">‚è∞ Time: <span id="time-display">--:--</span></span>
    </div>
    
    <script>
      // Update time display every second to show accurate current time
      function updateTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('time-display').textContent = hours + ':' + minutes;
      }
      updateTime();
      setInterval(updateTime, 1000);
    </script>

    {% if not created %}
    <div class="edit-notice">
      ‚ö†Ô∏è You've already marked attendance today. You can update the details.
    </div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="event_input">Event/Venue:</label>
        <input type="text" id="event_input" placeholder="Type event name..." autocomplete="off" required>
        <input type="hidden" name="event_fk" id="id_event_fk" value="">
        <input type="hidden" name="event_name" id="id_event_name" value="">
        <ul id="event_suggestions" style="list-style: none; padding: 5px 0; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; max-height: 150px; overflow-y: auto; display: none; background: white;"></ul>
      </div>

      <div class="form-group">
        <label for="id_overtime_hours">Overtime Hours:</label>
        <input type="number" name="overtime_hours" id="id_overtime_hours" 
               value="{{ form.overtime_hours.value|default:'0' }}" 
               min="0" max="24" placeholder="0" required>
      </div>

      <button type="submit">
        {% if created %}
          Submit Attendance
        {% else %}
          Update Attendance
        {% endif %}
      </button>
    </form>

    <script>
      const eventInput = document.getElementById('event_input');
      const eventFkInput = document.getElementById('id_event_fk');
      const eventNameInput = document.getElementById('id_event_name');
      const suggestionsList = document.getElementById('event_suggestions');
      let events = [];

      // Fetch all events on page load
      fetch('{% url "get_events" %}')
        .then(response => response.json())
        .then(data => {
          events = data.events;
        })
        .catch(error => console.error('Error fetching events:', error));

      // Show suggestions as user types
      eventInput.addEventListener('input', function() {
        const value = this.value.toLowerCase().trim();
        suggestionsList.innerHTML = '';

        if (value.length === 0) {
          suggestionsList.style.display = 'none';
          eventFkInput.value = '';
          eventNameInput.value = '';
          return;
        }

        // Filter matching events
        const matches = events.filter(event => 
          event.name.toLowerCase().includes(value)
        );

        if (matches.length > 0) {
          suggestionsList.style.display = 'block';
          matches.forEach(event => {
            const li = document.createElement('li');
            li.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;';
            li.textContent = event.name + ' (' + new Date(event.date).toLocaleDateString() + ')';
            li.onmouseover = () => li.style.backgroundColor = '#f0f0f0';
            li.onmouseout = () => li.style.backgroundColor = 'white';
            li.onclick = () => {
              eventInput.value = event.name;
              eventFkInput.value = event.id;
              eventNameInput.value = '';
              suggestionsList.innerHTML = '';
              suggestionsList.style.display = 'none';
            };
            suggestionsList.appendChild(li);
          });
        }

        // Add custom entry option if value doesn't exactly match any event
        if (!matches.some(e => e.name.toLowerCase() === value)) {
          const li = document.createElement('li');
          li.style.cssText = 'padding: 8px 12px; cursor: pointer; background: #f9f9f9; font-weight: bold; border-top: 1px solid #ddd;';
          li.textContent = '‚úì Use "' + value + '" as new event';
          li.onmouseover = () => li.style.backgroundColor = '#f0f0f0';
          li.onmouseout = () => li.style.backgroundColor = '#f9f9f9';
          li.onclick = () => {
            eventInput.value = value;
            eventFkInput.value = '';
            eventNameInput.value = value;
            suggestionsList.innerHTML = '';
            suggestionsList.style.display = 'none';
          };
          suggestionsList.appendChild(li);
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', function(event) {
        if (event.target !== eventInput && event.target !== suggestionsList) {
          suggestionsList.style.display = 'none';
        }
      });

      // Validate form before submission
      document.querySelector('form').addEventListener('submit', function(e) {
        const eventValue = eventInput.value.trim();
        if (!eventValue) {
          e.preventDefault();
          alert('Please select or enter an event name');
          return false;
        }
        
        // If user typed a custom event (not selected from suggestions), set it
        if (eventNameInput.value === '' && eventFkInput.value === '') {
          // Check if this matches any event
          const matchingEvent = events.find(e => e.name.toLowerCase() === eventValue.toLowerCase());
          if (matchingEvent) {
            eventFkInput.value = matchingEvent.id;
          } else {
            // Custom event - set the event_name field
            eventNameInput.value = eventValue;
          }
        }
      });
    </script>
    
    <div class="back-link">
      <a href="{% url 'dashboard' %}">Back to Dashboard</a>
      &nbsp;|&nbsp;
      <a href="{% url 'logout' %}">Logout</a>
    </div>
  </div>
</body>
</html>