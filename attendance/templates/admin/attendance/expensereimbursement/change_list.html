{% extends "admin/change_list.html" %}
{% load admin_urls static %}

{% block content_title %}
<h1>Expense Reimbursements</h1>
{% endblock %}

{% block search %}{% endblock %}

{% block date_hierarchy %}{% endblock %}

{% block filters %}{% endblock %}

{% block result_list %}
<style>
  .totals-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0 30px 0;
  }

  .total-card {
    background: linear-gradient(135deg, #0d2818 0%, #0a1d10 100%);
    color: #2ecc71;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left: 4px solid #2ecc71;
  }

  .total-card h3 {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #a0e4a0;
    font-weight: 600;
  }

  .total-card .amount {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
  }

  .reimbursement-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  .reimbursement-table thead {
    background: #0d2818;
    color: #2ecc71;
    font-weight: bold;
  }

  .reimbursement-table th {
    padding: 15px;
    text-align: left;
    border-bottom: 2px solid #2ecc71;
  }

  .reimbursement-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .reimbursement-table tbody tr:hover {
    background: #f9f9f9;
  }

  .status-select, .paid-select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    background: white;
    min-width: 120px;
  }

  .status-select:focus, .paid-select:focus {
    outline: none;
    border-color: #2ecc71;
    box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
  }

  .save-button-container {
    text-align: center;
    margin: 30px 0;
  }

  .btn-save {
    padding: 12px 30px;
    background: #2ecc71;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-save:hover {
    background: #27ae60;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
  }

  .empty-message {
    text-align: center;
    padding: 40px;
    color: #999;
  }
</style>

<div id="content-main">
  {% if total_requested %}
  <div class="totals-summary">
    <div class="total-card">
      <h3>Total Requested</h3>
      <p class="amount">{{ total_requested }}</p>
    </div>
    <div class="total-card">
      <h3>Total Approved</h3>
      <p class="amount">{{ total_approved }}</p>
    </div>
    <div class="total-card">
      <h3>Total Pending</h3>
      <p class="amount">{{ total_pending }}</p>
    </div>
    <div class="total-card">
      <h3>Total Paid</h3>
      <p class="amount">{{ total_paid }}</p>
    </div>
  </div>
  {% endif %}
  
  {% if result_list %}
  <form id="reimbursement-form" method="post" action="{% url 'admin:attendance_expensereimbursement_changelist' %}">
    {% csrf_token %}
    <table class="reimbursement-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Event</th>
          <th>Expense Type</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Requested At</th>
        </tr>
      </thead>
      <tbody>
        {% for reimbursement in result_list %}
        <tr data-reimbursement-id="{{ reimbursement.id }}">
          <td>
            <strong>{{ reimbursement.user.get_full_name|default:reimbursement.user.username }}</strong><br>
            <small>{{ reimbursement.user.email }}</small>
          </td>
          <td>
            {% if reimbursement.event %}
              {{ reimbursement.event.name }}
            {% else %}
              <span style="color: #999;">â€”</span>
            {% endif %}
          </td>
          <td>{{ reimbursement.get_expense_type_display }}</td>
          <td><strong style="color: #2ecc71;">KSH {{ reimbursement.amount }}</strong></td>
          <td>
            <select class="status-select" data-reimbursement-id="{{ reimbursement.id }}" name="status_{{ reimbursement.id }}">
              <option value="pending" {% if reimbursement.status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="approved" {% if reimbursement.status == 'approved' %}selected{% endif %}>Approved</option>
              <option value="rejected" {% if reimbursement.status == 'rejected' %}selected{% endif %}>Denied</option>
            </select>
          </td>
          <td>
            <select class="paid-select" data-reimbursement-id="{{ reimbursement.id }}" name="paid_{{ reimbursement.id }}" {% if reimbursement.status != 'approved' %}disabled{% endif %}>
              <option value="false" {% if not reimbursement.is_paid %}selected{% endif %}>Not Paid</option>
              <option value="true" {% if reimbursement.is_paid %}selected{% endif %}>Paid</option>
            </select>
          </td>
          <td>{{ reimbursement.requested_at|date:"M d, Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="save-button-container">
      <button type="submit" class="btn-save">
        <i class="fas fa-save"></i> Save All Changes
      </button>
    </div>
  </form>

  <script>
    // Enable/disable paid dropdown based on status
    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', function() {
        const row = this.closest('tr');
        const paidSelect = row.querySelector('.paid-select');
        const status = this.value;

        if (status === 'approved') {
          paidSelect.disabled = false;
        } else {
          paidSelect.disabled = true;
          paidSelect.value = 'false';
        }
      });
    });

    // Handle form submission
    document.getElementById('reimbursement-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const changes = [];
      document.querySelectorAll('tr[data-reimbursement-id]').forEach(row => {
        const reimbursementId = row.getAttribute('data-reimbursement-id');
        const statusSelect = row.querySelector('.status-select');
        const paidSelect = row.querySelector('.paid-select');

        if (statusSelect && paidSelect) {
          changes.push({
            id: reimbursementId,
            status: statusSelect.value,
            is_paid: paidSelect.value === 'true'
          });
        }
      });

      if (changes.length === 0) {
        alert('No reimbursements to save');
        return;
      }

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // Submit changes via AJAX
      fetch(window.location.href, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ changes: changes })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('All changes saved successfully!');
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to save changes');
      });
    });

    // Initialize paid dropdown states
    document.querySelectorAll('.status-select').forEach(select => {
      const row = select.closest('tr');
      const paidSelect = row.querySelector('.paid-select');
      if (select.value !== 'approved') {
        paidSelect.disabled = true;
      }
    });
  </script>
  {% else %}
  <div class="empty-message">
    <p>No expense reimbursements found.</p>
  </div>
  {% endif %}
</div>
{% endblock %}
